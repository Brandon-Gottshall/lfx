#!/usr/bin/env bash
set -euo pipefail

mode="${1:-local}"
owner="${LFX_GH_OWNER:-brandon-gottshall}"
repo="${LFX_GH_REPO:-lfx}"
ref="${LFX_GH_REF:-main}"
tap_name="${LFX_BREW_TAP:-lfx/local}"
tarball="${LFX_DEV_TARBALL:-}"
sha256="${LFX_DEV_SHA256:-}"

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "missing required command: $1" >&2
    exit 1
  fi
}

print_usage() {
  cat <<EOF >&2
usage: $0 [local|remote]
  local : build from the current repo and install via a fresh local tap
  remote: download a GitHub tarball and install via a fresh local tap

env:
  LFX_DEV_TARBALL path to a prebuilt tarball
  LFX_DEV_SHA256  sha256 for LFX_DEV_TARBALL
  LFX_BREW_TAP   tap name (default: lfx/local)
  LFX_GH_OWNER  GitHub owner (default: brandon-gottshall)
  LFX_GH_REPO   GitHub repo (default: lfx)
  LFX_GH_REF    Git ref for remote (default: main)
EOF
}

create_tap_repo() {
  tap_dir="$1"
  mkdir -p "${tap_dir}/Formula"
  git -C "${tap_dir}" init -q
}

commit_formula() {
  tap_dir="$1"
  git -C "${tap_dir}" add "Formula/lfx.rb"
  git -C "${tap_dir}" -c user.name=lfx -c user.email=lfx@local commit -m "add lfx formula" -q
}

ensure_tap_fresh() {
  if brew tap | rg -q "^${tap_name}$"; then
    brew untap "${tap_name}"
  fi
}

install_from_tap() {
  if brew list --formula | rg -q "^lfx$"; then
    brew reinstall --build-from-source "${tap_name}/lfx"
  else
    brew install --build-from-source "${tap_name}/lfx"
  fi
}

prepare_build_dir() {
  tmpdir="$(mktemp -d)"
  tap_dir="${tmpdir}/tap"
  create_tap_repo "${tap_dir}"
  trap 'rm -rf "${tmpdir}"' EXIT
}

install_local() {
  require_cmd brew
  require_cmd go
  require_cmd tar
  require_cmd shasum
  require_cmd git
  require_cmd uname
  require_cmd rg

  ensure_tap_fresh
  prepare_build_dir

  if [ -z "${tarball}" ]; then
    go build -o "${tmpdir}/lfx" ./cmd/lfx
    tarball="${tmpdir}/lfx-$(uname -s)-$(uname -m).tar.gz"
    tar -czf "${tarball}" -C "${tmpdir}" lfx
    sha256="$(shasum -a 256 "${tarball}" | awk '{print $1}')"
  elif [ -z "${sha256}" ]; then
    sha256="$(shasum -a 256 "${tarball}" | awk '{print $1}')"
  fi

  cat > "${tap_dir}/Formula/lfx.rb" <<EOF
class Lfx < Formula
  desc "Fast, pretty-by-default control-plane CLI for lf"
  homepage "https://github.com/${owner}/${repo}"
  version "0.0.0-dev"
  url "file://${tarball}"
  sha256 "${sha256}"

  def install
    bin.install "lfx"
  end
end
EOF

  commit_formula "${tap_dir}"
  brew tap "${tap_name}" "${tap_dir}"
  install_from_tap

  echo "Installed from local tap ${tap_name}." >&2
  echo "Cleanup: brew uninstall lfx && brew untap ${tap_name}" >&2
}

install_remote() {
  require_cmd brew
  require_cmd curl
  require_cmd shasum
  require_cmd tar
  require_cmd git
  require_cmd uname
  require_cmd rg

  ensure_tap_fresh
  prepare_build_dir

  tarball="${tmpdir}/lfx.tar.gz"
  url="https://github.com/${owner}/${repo}/archive/refs/heads/${ref}.tar.gz"
  curl -fsSL "${url}" -o "${tarball}"
  sha256="$(shasum -a 256 "${tarball}" | awk '{print $1}')"

  cat > "${tap_dir}/Formula/lfx.rb" <<EOF
class Lfx < Formula
  desc "Fast, pretty-by-default control-plane CLI for lf"
  homepage "https://github.com/${owner}/${repo}"
  version "0.0.0-dev"
  url "${url}"
  sha256 "${sha256}"
  depends_on "go"

  def install
    system "go", "build", "-o", bin/"lfx", "./cmd/lfx"
  end
end
EOF

  commit_formula "${tap_dir}"
  brew tap "${tap_name}" "${tap_dir}"
  install_from_tap

  echo "Installed from remote ${owner}/${repo}@${ref} via tap ${tap_name}." >&2
  echo "Cleanup: brew uninstall lfx && brew untap ${tap_name}" >&2
}

case "${mode}" in
  local)
    install_local
    ;;
  remote)
    install_remote
    ;;
  *)
    print_usage
    exit 1
    ;;
esac
